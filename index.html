<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ˜äººä¸è¯´ç‘è¯</title>
  <style>
    /* æ ·å¼ä¿æŒä¸å˜ */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
    body { background-color: #fdf2f8; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; color: #333; }
    .container { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); width: 100%; max-width: 400px; }
    .title { text-align: center; font-size: 24px; margin-bottom: 30px; color: #e53e3e; }
    .count-card { margin-bottom: 25px; }
    .card-title { font-size: 18px; margin-bottom: 10px; color: #4a5568; }
    .count-display { font-size: 60px; font-weight: bold; text-align: center; margin: 15px 0; color: #e53e3e; }
    .btn-group { display: flex; gap: 10px; justify-content: center; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.2s; }
    .btn-add { background-color: #e53e3e; color: white; }
    .btn-add:hover { background-color: #c53030; }
    .btn-reset { background-color: #e2e8f0; color: #4a5568; }
    .btn-reset:hover { background-color: #cbd5e1; }
    .debt-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0; text-align: center; }
    .debt-title { font-size: 18px; margin-bottom: 10px; color: #4a5568; }
    .debt-display { font-size: 28px; font-weight: bold; color: #9f7aea; }
    .reset-all-btn { margin-top: 30px; background-color: #38b2ac; color: white; }
    .reset-all-btn:hover { background-color: #319795; }
  </style>
</head>
<body>
  <!--  HTML ç»“æ„ä¿æŒä¸å˜ -->
  <div class="container">
    <h1 class="title">æ˜äººä¸è¯´ç‘è¯</h1>

    <div class="count-card">
      <h2 class="card-title">æ˜å“¥å–æ°´æ¬¡æ•°</h2>
      <div class="count-display" id="myCount">0</div>
      <div class="btn-group">
        <button class="btn btn-add" onclick="addMyCount()">+1 å–æ°´å•¦</button>
        <button class="btn btn-reset" onclick="resetMyCount()">å½“æˆ‘æ²¡å–</button>
      </div>
    </div>

    <div class="count-card">
      <h2 class="card-title">ç‘å®çš„å–æ°´æ¬¡æ•°</h2>
      <div class="count-display" id="herCount">0</div>
      <div class="btn-group">
        <button class="btn btn-add" onclick="addHerCount()">+1 å–æ°´å•¦</button>
        <button class="btn btn-reset" onclick="resetHerCount()">å½“æˆ‘æ²¡å–</button>
      </div>
    </div>

    <div class="debt-section">
      <h2 class="debt-title">å·²æ¬ å–æ°´æ¬¡æ•°</h2>
      <div class="debt-display" id="debtCount">è°éƒ½ä¸æ¬ </div>
    </div>

    <button class="btn reset-all-btn" onclick="resetAllCount()">åœ°çƒçˆ†ç‚¸</button>
  </div>

  <!-- ä½¿ç”¨ LeanCloud å›½å†… CDN -->
  <script src="https://cdn.leancloud.cn/sdk/4.17.0/av-min.js"></script>
  <script>
    // âœ… åˆå§‹åŒ– LeanCloudï¼ˆç¡®ä¿ serverURL æ­£ç¡®ï¼‰
    AV.init({
      appId: "2NJBHssy4tDPSZ6JYpuFdzBI-gzGzoHsz",
      appKey: "HUkKwNJJw8IRVGjq3NsaLXUA",
      serverURL: "https://2njbhssy.lc-cn-n1-shared.com"
    });

    const DrinkRecord = AV.Object.extend('DrinkRecord');
    let currentRecord = null;

    // âœ… ç¡®ä¿åªæœ‰ä¸€æ¡è®°å½•ï¼ˆç”¨å›ºå®š objectIdï¼‰
    const FIXED_OBJECT_ID = 'drink_record_001';

    // é¡µé¢åŠ è½½
    window.onload = function() {
      fetchOrCreateRecord().then(() => {
        renderUI();
      }).catch(err => {
        console.error('åˆå§‹åŒ–å¤±è´¥:', err);
        alert('ç½‘ç»œä¸ç¨³ï¼Œè¯·åˆ·æ–°è¯•è¯•ï½');
      });
    };

    // è·å–æˆ–åˆ›å»ºå”¯ä¸€è®°å½•
    async function fetchOrCreateRecord() {
      const query = new AV.Query(DrinkRecord);
      query.equalTo('objectId', FIXED_OBJECT_ID);
      let record = await query.first();

      if (!record) {
        record = new DrinkRecord();
        record.set('objectId', FIXED_OBJECT_ID);
        record.set('myCount', 0);
        record.set('herCount', 0);
        await record.save(null, { useMasterKey: false });
      }
      currentRecord = record;
    }

    // æ¸²æŸ“é¡µé¢
    function renderUI() {
      const myCount = currentRecord.get('myCount') || 0;
      const herCount = currentRecord.get('herCount') || 0;
      document.getElementById('myCount').innerText = myCount;
      document.getElementById('herCount').innerText = herCount;
      updateDebtCount(myCount, herCount);
    }

    function updateDebtCount(myCount, herCount) {
      const debtDisplay = document.getElementById('debtCount');
      const diff = Number(myCount) - Number(herCount);
      if (diff === 0) {
        debtDisplay.innerText = "è°éƒ½ä¸æ¬ ";
      } else if (diff > 0) {
        debtDisplay.innerText = `ç‘å®æ¬ æ˜å“¥ ${diff} æ¬¡å–æ°´ğŸ˜œ`;
      } else {
        debtDisplay.innerText = `æ˜å“¥æ¬ ç‘å® ${-diff} æ¬¡å–æ°´ğŸ¥º`;
      }
    }

    // âœ… ä½¿ç”¨ increment åŸå­æ“ä½œ
    async function addMyCount() {
      try {
        await currentRecord.increment('myCount', 1).save();
        await fetchOrCreateRecord(); // é‡æ–°æ‹‰å–æœ€æ–°æ•°æ®
        renderUI();
      } catch (err) {
        alert('å–æ°´å¤±è´¥å•¦ï½ç½‘ç»œä¸ç¨³ï¼Ÿ');
        console.error('æ˜å“¥å–æ°´å¤±è´¥:', err);
      }
    }

    async function addHerCount() {
      try {
        await currentRecord.increment('herCount', 1).save();
        await fetchOrCreateRecord();
        renderUI();
      } catch (err) {
        alert('å–æ°´å¤±è´¥å•¦ï½ç½‘ç»œä¸ç¨³ï¼Ÿ');
        console.error('ç‘å®å–æ°´å¤±è´¥:', err);
      }
    }

    // é‡ç½®ï¼ˆç›´æ¥è®¾ä¸º0ï¼‰
    async function resetMyCount() {
      try {
        currentRecord.set('myCount', 0);
        await currentRecord.save();
        renderUI();
      } catch (err) {
        console.error('é‡ç½®æ˜å“¥å¤±è´¥:', err);
      }
    }

    async function resetHerCount() {
      try {
        currentRecord.set('herCount', 0);
        await currentRecord.save();
        renderUI();
      } catch (err) {
        console.error('é‡ç½®ç‘å®å¤±è´¥:', err);
      }
    }

    async function resetAllCount() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å–æ°´è®°å½•å—')) return;
      try {
        currentRecord.set('myCount', 0);
        currentRecord.set('herCount', 0);
        await currentRecord.save();
        renderUI();
      } catch (err) {
        console.error('é‡ç½®æ‰€æœ‰å¤±è´¥:', err);
      }
    }
  </script>
</body>
</html>
